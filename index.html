<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Gesti√≥n de Pedidos | App</title>
    <style>
        /* Estilos CSS (Puedes colocarlos en un archivo style.css si quieres) */
        :root {
            --primary-color: #ff66b2; /* Rosa Fuerte */
            --secondary-color: #66b2ff; /* Azul Claro */
            --background-color: #f7f7f7;
            --text-color: #333;
            --card-bg: #fff;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #header-branding {
            display: flex;
            align-items: center;
        }

        #header-branding img {
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
        }

        #header-app-name {
            font-size: 1.5em;
            color: var(--primary-color);
            font-weight: bold;
        }

        #fecha-actual-display {
            font-size: 0.9em;
            color: #666;
        }

        main {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 10px;
        }

        nav#main-nav {
            width: 200px;
            min-width: 200px;
            margin-right: 20px;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        nav#main-nav button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: var(--border-radius);
            background-color: #eee;
            color: var(--text-color);
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        nav#main-nav button:hover {
            background-color: #e0e0e0;
        }

        nav#main-nav button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        section.content-area {
            flex-grow: 1;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .app-section {
            display: none;
        }

        .app-section.active-section {
            display: block;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* --- Formularios --- */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1em;
            background-color: #fcfcfc;
        }

        input:disabled, select:disabled, textarea:disabled {
            background-color: #eee;
        }

        button.btn-primary, button.btn-secondary {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-right: 10px;
        }

        button.btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        button.btn-primary:hover:not(:disabled) {
            background-color: #e6559d;
        }
        
        button.btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        button.btn-secondary:hover:not(:disabled) {
            background-color: #559de6;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .input-group > .form-group {
            flex: 1;
        }

        .input-group button {
            height: 40px; 
            min-width: 100px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* --- Listas --- */
        #lista-clientes-control,
        #lista-catalogo,
        #lista-pedidos-completa {
            list-style: none;
            padding: 0;
        }

        #lista-clientes-control > div {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .catalogo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #f0f0f0;
            margin-bottom: 5px;
            border-radius: var(--border-radius);
            background-color: #fcfcfc;
        }
        
        .catalogo-item strong {
            color: var(--primary-color);
        }

        .catalogo-item button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            margin-left: 5px;
        }

        /* --- Carrito/Pedido Actual --- */
        #items-pedido-lista {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 100px;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
        }
        
        .carrito-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .carrito-item:last-child {
            border-bottom: none;
        }
        
        .carrito-item button {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            font-weight: bold;
        }
        
        #pedido-resumen {
            text-align: right;
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 0;
            border-top: 2px solid var(--secondary-color);
        }
        
        #pedido-total-resumen {
            color: var(--primary-color);
            font-size: 1.2em;
        }

        /* --- Lista de Pedidos --- */
        #lista-pedidos-completa {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .pedido-card {
            background-color: var(--card-bg);
            border: 1px solid #eee;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 5px solid;
        }

        .pedido-card h3 {
            margin-top: 0;
            color: var(--secondary-color);
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 5px;
        }
        
        .pedido-card p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .pedido-card.estado-Pendiente { border-left-color: orange; }
        .pedido-card.estado-En_Proceso { border-left-color: blue; }
        .pedido-card.estado-Entregado { border-left-color: green; }
        
        .pedido-card select {
            width: auto;
            margin-left: 10px;
            padding: 5px;
            font-size: 0.9em;
        }
        
        .action-buttons-pedido {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .action-buttons-pedido button {
            padding: 5px 10px;
            font-size: 0.8em;
            margin: 0;
        }

        /* --- Filtros --- */
        #filtro-estado-contenedor {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filtro-estado-btn {
            background-color: #ddd;
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .filtro-estado-btn.active,
        .filtro-estado-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* --- Reportes --- */
        #reportes-nav {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .reportes-nav-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }

        .reportes-nav-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .reporte-content {
            display: none;
        }
        
        .reporte-content.active {
            display: block;
        }

        .reporte-content ul {
            list-style: none;
            padding: 0;
        }
        
        .reporte-content ul li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 600px;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: var(--shadow);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
        }

        /* --- Notificaci√≥n (Toast) --- */
        #app-notification {
            visibility: hidden; 
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        #app-notification.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        #app-notification.notification-success { background-color: green; }
        #app-notification.notification-error { background-color: red; }
        #app-notification.notification-info { background-color: blue; }

        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;} 
            to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        /* Estilos espec√≠ficos del carrito de edici√≥n */
        #items-pedido-edicion-lista .carrito-item input[type="number"] {
            width: 60px !important; 
            text-align: center;
            padding: 5px;
            height: auto;
        }
        #items-pedido-edicion-lista .carrito-item span:first-child {
            flex-basis: 45%; 
        }
        #items-pedido-edicion-lista .carrito-item span:nth-child(3) {
            flex-basis: 25%;
            text-align: right; 
            font-weight: bold;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
                padding: 10px;
            }
            nav#main-nav {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                position: static;
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            section.content-area {
                padding: 15px;
            }
            .pedido-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <header>
        <div id="header-branding">
            <span id="header-app-name">Gesti√≥n de Pedidos</span>
        </div>
        <span id="fecha-actual-display"></span>
    </header>

    <main>
        <nav id="main-nav">
            <button class="nav-button active" data-target="pedidos-section">Nuevo Pedido</button>
            <button class="nav-button" data-target="lista-pedidos-section">Lista de Pedidos</button>
            <button class="nav-button" data-target="clientes-section">Clientes</button>
            <button class="nav-button" data-target="catalogo-section">Cat√°logo/Productos</button>
            <button class="nav-button" data-target="reportes-section">Reportes</button>
            <button class="nav-button" data-target="configuracion-section">Configuraci√≥n</button>
        </nav>

        <section class="content-area">

            <div id="pedidos-section" class="app-section active-section">
                <h2>Nuevo Pedido</h2>
                <form id="form-pedido">
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="pedido-cliente">Cliente</label>
                            <select id="pedido-cliente" required>
                                <option value="">-- Selecciona un Cliente para Empezar --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pedido-fecha-entrega">Fecha de Entrega (Opcional)</label>
                            <input type="date" id="pedido-fecha-entrega">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="pedido-medio-pago">Medio de Pago</label>
                            <select id="pedido-medio-pago" required disabled>
                                <option value="">Seleccionar</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia/CBU/Alias</option>
                                <option value="Mercado Pago">Mercado Pago</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pedido-tipo-entrega">Tipo de Entrega</label>
                            <select id="pedido-tipo-entrega" required disabled>
                                <option value="">Seleccionar</option>
                                <option value="Retira">Retira en Local</option>
                                <option value="Envio a Domicilio">Env√≠o a Domicilio</option>
                                <option value="Punto de Encuentro">Punto de Encuentro</option>
                            </select>
                        </div>
                    </div>

                    <div style="border: 1px solid var(--secondary-color); padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius);">
                        <h3>Agregar Producto</h3>
                        <div class="input-group">
                            <div class="form-group" style="flex: 3;">
                                <label for="pedido-producto">Producto</label>
                                <select id="pedido-producto" disabled>
                                    <option value="">Selecciona un Producto</option>
                                    </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="pedido-cantidad">Cantidad</label>
                                <input type="number" id="pedido-cantidad" value="1" min="1" disabled>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="pedido-precio-unitario">P. Unitario</label>
                                <input type="number" id="pedido-precio-unitario" readonly disabled>
                            </div>
                            <button type="button" id="btn-agregar-item" class="btn-secondary" disabled>‚ûï Agregar</button>
                        </div>

                        <h4>√çtems del Pedido:</h4>
                        <div id="items-pedido-lista">
                            <p style="text-align: center; color: #aaa;">No hay productos en el pedido.</p>
                        </div>
                        
                        <div id="pedido-resumen">
                            Total: <span id="pedido-total-resumen">$0.00</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pedido-observaciones">Observaciones del Pedido</label>
                        <textarea id="pedido-observaciones" rows="3" disabled></textarea>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" id="btn-vaciar-carrito" class="btn-secondary" disabled>Vaciar Carrito</button>
                        <button type="submit" id="btn-finalizar-pedido" class="btn-primary" disabled>Finalizar y Guardar Pedido</button>
                    </div>
                </form>
            </div>

            <div id="lista-pedidos-section" class="app-section">
                <h2>Lista de Pedidos</h2>
                <div class="form-group">
                    <label for="buscar-pedido">Buscar Pedido (ID, Cliente, Producto, Fecha)</label>
                    <input type="text" id="buscar-pedido" placeholder="Buscar pedidos...">
                </div>
                
                <div id="filtro-estado-contenedor">
                    <button type="button" class="filtro-estado-btn active" data-estado="">TODOS</button>
                    <button type="button" class="filtro-estado-btn" data-estado="Pendiente">PENDIENTES</button>
                    <button type="button" class="filtro-estado-btn" data-estado="En Proceso">EN PROCESO</button>
                    <button type="button" class="filtro-estado-btn" data-estado="Entregado">ENTREGADOS</button>
                </div>
                
                <div id="lista-pedidos-completa">
                    </div>
            </div>

            <div id="clientes-section" class="app-section">
                <h2>Clientes</h2>
                
                <div id="form-nuevo-cliente-container">
                    <h3>Registrar Nuevo Cliente</h3>
                    <form id="form-cliente">
                        <div class="form-group">
                            <label for="cliente-nombre">Nombre Completo</label>
                            <input type="text" id="cliente-nombre" required>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="cliente-telefono">Tel√©fono</label>
                                <input type="text" id="cliente-telefono" placeholder="Ej: 3415555555">
                            </div>
                            <div class="form-group">
                                <label for="cliente-direccion">Direcci√≥n</label>
                                <input type="text" id="cliente-direccion" placeholder="Ej: Calle Falsa 123">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" id="btn-importar-contacto" class="btn-secondary">Importar Contacto üì≤</button>
                            <button type="submit" class="btn-primary">Guardar Cliente</button>
                        </div>
                    </form>
                </div>
                
                <div id="form-edicion-cliente-container" class="hidden" style="border: 2px solid var(--secondary-color); padding: 15px; border-radius: var(--border-radius); margin-top: 20px;">
                    <h3>Editar Cliente Seleccionado</h3>
                    <form id="form-edicion-cliente">
                        <input type="hidden" id="edit-cliente-id">
                        <div class="form-group">
                            <label for="edit-cliente-nombre">Nombre Completo</label>
                            <input type="text" id="edit-cliente-nombre" required>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="edit-cliente-telefono">Tel√©fono</label>
                                <input type="text" id="edit-cliente-telefono">
                            </div>
                            <div class="form-group">
                                <label for="edit-cliente-direccion">Direcci√≥n</label>
                                <input type="text" id="edit-cliente-direccion">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" id="btn-cancelar-edicion-cliente" class="btn-secondary">Cancelar</button>
                            <button type="submit" class="btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
                
                <hr style="margin: 30px 0;">
                
                <h3>Lista de Clientes Registrados</h3>
                <div class="input-group">
                    <div class="form-group" style="flex: 1;">
                        <label for="buscar-cliente">Buscar/Filtrar</label>
                        <input type="text" id="buscar-cliente" placeholder="Buscar por nombre, tel o direcci√≥n">
                    </div>
                </div>
                
                <div id="lista-clientes-control">
                    <div class="input-group">
                        <div class="form-group" style="flex: 2;">
                            <label for="select-clientes">Seleccionar Cliente para Acciones</label>
                            <select id="select-clientes" size="5">
                                </select>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                            <button type="button" id="btn-editar-cliente" class="btn-secondary" disabled>‚úèÔ∏è Editar</button>
                            <button type="button" id="btn-eliminar-cliente" class="btn-primary" disabled>‚ùå Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="catalogo-section" class="app-section">
                <h2>Cat√°logo de Productos</h2>
                
                <div id="form-nuevo-producto-container">
                    <h3>Agregar Nuevo Producto</h3>
                    <form id="form-producto">
                        <div class="input-group">
                            <div class="form-group" style="flex: 2;">
                                <label for="producto-nombre-nuevo">Nombre del Producto</label>
                                <input type="text" id="producto-nombre-nuevo" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="producto-precio-nuevo">Precio Unitario ($)</label>
                                <input type="number" id="producto-precio-nuevo" min="0.01" step="0.01" required>
                            </div>
                            <button type="submit" class="btn-primary">Guardar Producto</button>
                        </div>
                    </form>
                </div>
                
                <div id="form-edicion-producto-container" class="hidden" style="border: 2px solid var(--secondary-color); padding: 15px; border-radius: var(--border-radius); margin-top: 20px;">
                    <h3>Editar Producto</h3>
                    <form id="form-edicion-producto">
                        <input type="hidden" id="edit-producto-id">
                        <div class="input-group">
                            <div class="form-group" style="flex: 2;">
                                <label for="edit-producto-nombre">Nombre del Producto</label>
                                <input type="text" id="edit-producto-nombre" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="edit-producto-precio">Precio Unitario ($)</label>
                                <input type="number" id="edit-producto-precio" min="0.01" step="0.01" required>
                            </div>
                            <div style="flex-basis: 100px; display: flex; flex-direction: column; gap: 5px;">
                                <button type="button" id="btn-cancelar-edicion-producto" class="btn-secondary">Cancelar</button>
                                <button type="submit" class="btn-primary">Guardar Cambios</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <hr style="margin: 30px 0;">
                
                <h3>Productos en Cat√°logo</h3>
                <ul id="lista-catalogo">
                    <li>No hay productos en el cat√°logo.</li>
                </ul>
            </div>

            <div id="reportes-section" class="app-section">
                <h2>Reportes de Ventas Entregadas</h2>
                
                <div id="reportes-nav">
                    <button type="button" class="reportes-nav-btn active" data-reporte="diario">Ventas por D√≠a</button>
                    <button type="button" class="reportes-nav-btn" data-reporte="mensual">Ventas por Mes</button>
                    <button type="button" class="reportes-nav-btn" data-reporte="productos">Productos Vendidos</button>
                    <button type="button" class="reportes-nav-btn" data-reporte="pagos">Medios de Pago</button>
                </div>
                
                <button type="button" id="btn-exportar-reporte" class="btn-secondary" style="margin-bottom: 20px;">Exportar Reporte Activo (CSV)</button>

                <div id="reporte-diario-content" class="reporte-content active">
                    <h3>Ventas Totales por D√≠a</h3>
                    <ul id="reporte-diario"></ul>
                </div>

                <div id="reporte-mensual-content" class="reporte-content">
                    <h3>Ventas Totales por Mes</h3>
                    <ul id="reporte-mensual"></ul>
                </div>

                <div id="reporte-productos-content" class="reporte-content">
                    <h3>Ranking de Productos Vendidos</h3>
                    <ul id="reporte-productos"></ul>
                </div>

                <div id="reporte-pagos-content" class="reporte-content">
                    <h3>Ventas por Medio de Pago</h3>
                    <ul id="reporte-pagos"></ul>
                </div>
            </div>

            <div id="configuracion-section" class="app-section">
                <h2>Configuraci√≥n del Sistema</h2>
                
                <form id="form-configuracion">
                    <h3>Datos de la Empresa</h3>
                    <div class="form-group">
                        <label for="config-nombre">Nombre de tu Emprendimiento/App</label>
                        <input type="text" id="config-nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="config-logo-url">URL del Logo (Opcional, para cabecera)</label>
                        <input type="text" id="config-logo-url">
                    </div>
                    <div class="form-group">
                        <label for="config-telefono">Tel√©fono/WhatsApp de Contacto (Ej: 549341xxxxxx)</label>
                        <input type="text" id="config-telefono">
                    </div>
                    <div class="form-group">
                        <label for="config-redes">Redes Sociales (Ej: @miemprendimiento)</label>
                        <input type="text" id="config-redes">
                    </div>

                    <h3>Datos Bancarios (Transferencia)</h3>
                    <div class="form-group">
                        <label for="config-cbu-alias">CBU / ALIAS</label>
                        <input type="text" id="config-cbu-alias">
                    </div>
                    <div class="form-group">
                        <label for="config-titular">Titular de la Cuenta</label>
                        <input type="text" id="config-titular">
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button type="button" id="btn-compartir-datos-bancarios" class="btn-secondary">Compartir Datos Bancarios üí¨</button>
                        <button type="submit" class="btn-primary">Guardar Configuraci√≥n</button>
                    </div>
                </form>
                
                <hr style="margin: 30px 0;">
                
                <h3>Vista Previa de Configuraci√≥n Guardada</h3>
                <div id="config-preview" style="background-color: #f9f9f9; padding: 15px; border-radius: var(--border-radius);">
                    </div>
            </div>

        </section>
    </main>

    <div id="modal-edicion-pedido" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-edicion-pedido">&times;</span>
            <h2>Editar Pedido <span id="edit-pedido-id-display">#0</span></h2>
            <form id="form-edicion-pedido-modal">
                <input type="hidden" id="edit-pedido-id-hidden">
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="edit-pedido-medio-pago">Medio de Pago</label>
                        <select id="edit-pedido-medio-pago" required>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia/CBU/Alias</option>
                            <option value="Mercado Pago">Mercado Pago</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-pedido-tipo-entrega">Tipo de Entrega</label>
                        <select id="edit-pedido-tipo-entrega" required>
                            <option value="Retira">Retira en Local</option>
                            <option value="Envio a Domicilio">Env√≠o a Domicilio</option>
                            <option value="Punto de Encuentro">Punto de Encuentro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-pedido-fecha-entrega">Fecha de Entrega</label>
                    <input type="date" id="edit-pedido-fecha-entrega">
                </div>

                <h4>√çtems del Pedido: (Modifica la cantidad o elimina el √≠tem)</h4>
                <div id="items-pedido-edicion-lista">
                    </div>
                
                <div id="pedido-resumen" style="border-top: none;">
                    Total: <span id="pedido-total-edicion-resumen">$0.00</span>
                </div>

                <div class="form-group">
                    <label for="edit-pedido-observaciones">Observaciones</label>
                    <textarea id="edit-pedido-observaciones" rows="3"></textarea>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button type="submit" class="btn-primary">Guardar Cambios del Pedido</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="app-notification"></div>

    <script src="script.js"></script>
</body>
</html>
/* Estilos Base y Reseteo */
:root {
    --primary-color: #ff66b2; /* Rosa Fuerte */
    --primary-color-dark: #e04a98;
    --secondary-color: #4a90e2; /* Azul */
    --text-dark: #333;
    --text-light: #fff;
    --background-light: #f4f4f4;
    --card-background: #ffffff;
    --success-color: #4CAF50; /* Verde */
    --error-color: #F44336; /* Rojo */
    --info-color: #2196F3; /* Azul Claro */
    --pending-color: #FFC107; /* Amarillo */
    --process-color: #00BCD4; /* Cian */
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: sans-serif;
}

body {
    background-color: var(--background-light);
    color: var(--text-dark);
    line-height: 1.6;
}

main {
    padding: 20px;
}

/* Header y Navegaci√≥n */
header {
    background-color: var(--card-background);
    color: var(--text-dark);
    padding: 10px 20px;
    border-bottom: 2px solid var(--primary-color);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
}

#header-branding {
    display: flex;
    align-items: center;
    gap: 15px;
}

#header-branding img {
    height: 40px;
    width: auto;
    border-radius: 50%;
}

#header-branding h1 {
    font-size: 1.5em;
    color: var(--primary-color);
}

.fecha-display {
    font-size: 0.9em;
    color: #666;
    font-style: italic;
}

#main-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 5px;
}

.nav-button {
    background: none;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    font-weight: bold;
    color: var(--text-dark);
    border-radius: 5px;
    transition: background-color 0.2s, color 0.2s;
}

.nav-button:hover {
    background-color: #ffecf6;
}

.nav-button.active {
    background-color: var(--primary-color);
    color: var(--text-light);
}

/* Estilos de Botones */
button {
    cursor: pointer;
    padding: 10px 15px;
    border-radius: 5px;
    font-weight: bold;
    transition: background-color 0.2s, opacity 0.2s;
    border: 1px solid transparent;
}

.btn-primary {
    background-color: var(--primary-color);
    color: var(--text-light);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--primary-color-dark);
}

.secondary-btn {
    background-color: #f0f0f0;
    color: var(--text-dark);
    border-color: #ccc;
}

.secondary-btn:hover {
    background-color: #e0e0e0;
}

button:disabled, .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Secciones de la App (Pesta√±as) */
.app-section {
    display: none; /* Oculta todas las secciones por defecto */
    padding: 20px;
    background-color: var(--card-background);
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
}

.app-section.active-section {
    display: block; /* Muestra la secci√≥n activa */
}

.app-section h2 {
    color: var(--primary-color);
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
}

/* Formularios y Inputs */
form label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
}

form input[type="text"],
form input[type="number"],
form input[type="tel"],
form input[type="url"],
form input[type="date"],
form select,
form textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
}

fieldset {
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
}

legend {
    font-weight: bold;
    color: var(--secondary-color);
    padding: 0 10px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

/* Carrito y Productos */
.item-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

.lista-carrito {
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
    max-height: 200px;
    overflow-y: auto;
}

.carrito-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
}

.carrito-item:last-child {
    border-bottom: none;
}

.carrito-item button {
    padding: 5px 8px;
    font-size: 0.8em;
    background-color: var(--error-color);
    color: var(--text-light);
    border: none;
    margin-left: 10px;
}

.pedido-total {
    text-align: right;
    font-size: 1.2em;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 2px solid var(--primary-color);
}

/* Secci√≥n Clientes */
.clientes-forms-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (min-width: 768px) {
    .clientes-forms-container {
        grid-template-columns: 1fr 1fr;
    }
    .clientes-forms-container > #btn-importar-contacto {
        grid-column: 1 / 2;
        align-self: flex-start;
        width: 100%;
    }
}

.clientes-forms-container h3 {
    color: var(--secondary-color);
    margin-bottom: 10px;
}

.clientes-lista-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-top: 10px;
}

#select-clientes {
    flex-grow: 1;
    min-width: 200px;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

/* Secci√≥n Cat√°logo */
.catalogo-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}

@media (min-width: 768px) {
    .catalogo-grid {
        grid-template-columns: 1fr 1fr;
    }
}

.lista-catalogo {
    list-style: none;
    padding: 0;
}

.catalogo-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px dashed #ddd;
}

.catalogo-item span {
    flex-grow: 1;
}

.catalogo-item strong {
    color: var(--error-color);
    margin-right: 15px;
}

.catalogo-item button {
    background: none;
    border: none;
    padding: 5px;
    font-size: 1em;
    margin-left: 5px;
}
.catalogo-item button:hover {
    background-color: #eee;
    border-radius: 4px;
}

.btn-eliminar-producto {
    color: var(--error-color);
}

/* Secci√≥n Lista de Pedidos */
.controls-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

#filtro-estado-contenedor {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.filtro-estado-btn {
    background: #eee;
    border: 1px solid #ccc;
    color: var(--text-dark);
    padding: 5px 10px;
    font-size: 0.9em;
}

.filtro-estado-btn.active {
    background-color: var(--secondary-color);
    color: var(--text-light);
    border-color: var(--secondary-color);
}

.lista-pedidos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.pedido-card {
    background-color: var(--card-background);
    padding: 15px;
    border-radius: 8px;
    border-left: 5px solid;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.pedido-card h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.2em;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.pedido-card p {
    margin-bottom: 5px;
}

/* Colores de Estado de Pedido */
.estado-Pendiente {
    border-left-color: var(--pending-color);
}
.estado-En_Proceso {
    border-left-color: var(--process-color);
}
.estado-Entregado {
    border-left-color: var(--success-color);
}

/* Botones de Acci√≥n de Pedido */
.action-buttons-pedido button {
    padding: 5px 10px;
    font-size: 0.85em;
}

.btn-eliminar-pedido {
    background-color: var(--error-color);
    color: var(--text-light);
}

/* Modal de Edici√≥n de Pedido */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background-color: var(--card-background);
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content h2 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 20px;
}

.close-btn:hover,
.close-btn:focus {
    color: #333;
    text-decoration: none;
}

/* Notificaci√≥n (Toast) */
#app-notification {
    visibility: hidden; 
    min-width: 250px;
    background-color: #333;
    color: var(--text-light);
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 1001;
    left: 50%;
    transform: translateX(-50%);
    bottom: 30px;
    font-size: 17px;
    opacity: 0;
    transition: opacity 0.3s, background-color 0.3s;
}

#app-notification.show {
    visibility: visible; 
    opacity: 1;
}

.notification-success {
    background-color: var(--success-color);
}
.notification-error {
    background-color: var(--error-color);
}
.notification-info {
    background-color: var(--info-color);
}

/* Secci√≥n Reportes */
.reportes-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
}

.reportes-nav-btn {
    background: #eee;
    border: 1px solid #ccc;
    color: var(--text-dark);
}

.reportes-nav-btn.active {
    background-color: var(--primary-color);
    color: var(--text-light);
    border-color: var(--primary-color);
}

.reporte-content {
    display: none;
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 5px;
}

.reporte-content.active {
    display: block;
}

.reporte-content h3 {
    color: var(--secondary-color);
    margin-bottom: 10px;
}

.reporte-content ul {
    list-style: none;
}

.reporte-content ul li {
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
}

/* Secci√≥n Configuraci√≥n */
.config-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}

@media (min-width: 768px) {
    .config-grid {
        grid-template-columns: 2fr 1fr;
    }
}

.preview-box {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
}
.preview-box h3, .preview-box h4 {
    color: var(--secondary-color);
}


/* Media Queries para Responsividad */
@media (max-width: 600px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    #main-nav {
        margin-top: 10px;
        width: 100%;
        justify-content: space-around;
    }
    .nav-button {
        flex-grow: 1;
        text-align: center;
        padding: 8px 5px;
        font-size: 0.9em;
    }
    .clientes-lista-controls {
        flex-direction: column;
    }
    #select-clientes {
        width: 100%;
    }
    .action-buttons {
        width: 100%;
        justify-content: space-between;
    }
    .item-input-group {
        flex-wrap: wrap;
    }
    .item-input-group select, 
    .item-input-group input {
        flex-grow: 1;
        width: 100%; /* Forzar ancho completo en m√≥viles */
    }
    .item-input-group button {
        width: 100%;
    }
    .controls-container input[type="text"] {
        width: 100%;
    }
}// ==========================================================
// 1. VARIABLES GLOBALES Y CARGA INICIAL
// ==========================================================
let clientes = []; 
let pedidos = [];
let ventasHistorial = []; 
let catalogo = []; 
let carrito = []; 
let carritoEdicion = []; 
let configuracion = {}; 

let contadorPedidos = 0; 

/**
 * Funci√≥n de utilidad para guardar datos en localStorage.
 */
const guardarDatos = (key, data) => {
    localStorage.setItem(key, JSON.stringify(data));
};

/**
 * Funci√≥n de utilidad para guardar el contador de pedidos.
 * Se asegura de guardar solo n√∫meros cortos (no los de 13 cifras).
 */
const guardarContador = () => {
    // Solo guardamos el contador si es un n√∫mero razonablemente corto
    if (contadorPedidos < 1000000) {
        localStorage.setItem('contadorPedidos', contadorPedidos);
    }
};

/**
 * Funci√≥n para cargar todos los arrays desde localStorage.
 * ‚úÖ CORRECCI√ìN ID: Reinicia/asegura el contador al m√°ximo ID corto encontrado.
 */
const cargarDatosIniciales = () => {
    clientes = JSON.parse(localStorage.getItem('clientes')) || []; 
    pedidos = JSON.parse(localStorage.getItem('pedidos')) || []; 
    ventasHistorial = JSON.parse(localStorage.getItem('ventasHistorial')) || []; 
    catalogo = JSON.parse(localStorage.getItem('catalogo')) || []; 
    
    // Si el valor guardado es un n√∫mero de 13 cifras, lo ignoramos (timestamp).
    let contadorGuardado = parseInt(localStorage.getItem('contadorPedidos')) || 0;
    if (contadorGuardado >= 1000000) { 
        contadorGuardado = 0;
    }
    
    let maxIdExistente = 0;

    if (pedidos.length > 0) {
        maxIdExistente = pedidos.reduce((max, p) => {
            const currentId = parseInt(p.id);
            // Solo considera IDs que sean razonablemente cortos (m√°ximo 6 d√≠gitos) 
            // y que sean mayores que el m√°ximo actual.
            if (currentId < 1000000 && currentId > max) { 
                 return currentId; 
            }
            return max;
        }, 0);
    } 

    // El contador ser√° el mayor entre el guardado y el ID m√°ximo existente.
    contadorPedidos = Math.max(contadorGuardado, maxIdExistente);
    
    // Guardamos este valor forzado para que persista el conteo corto y sucesivo.
    guardarContador();

    configuracion = JSON.parse(localStorage.getItem('configuracion')) || {
        nombre: 'Gesti√≥n de Pedidos',
        logoUrl: '',
        telefono: '',
        redes: '',
        cbuAlias: '',
        titular: ''
    };
};


// ==========================================================
// 2. SELECTORES DEL DOM (COMPLETOS Y CORREGIDOS)
// ==========================================================
const formCliente = document.getElementById('form-cliente');
const selectClientesList = document.getElementById('select-clientes');
const formPedido = document.getElementById('form-pedido');
const selectPedidoCliente = document.getElementById('pedido-cliente');
const selectPedidoProducto = document.getElementById('pedido-producto'); 
const inputPedidoPrecioUnitario = document.getElementById('pedido-precio-unitario');
const inputPedidoCantidad = document.getElementById('pedido-cantidad');
const btnAgregarItem = document.getElementById('btn-agregar-item');
const itemsPedidoListaDiv = document.getElementById('items-pedido-lista');
const pedidoTotalResumenSpan = document.getElementById('pedido-total-resumen');
const inputPedidoObservaciones = document.getElementById('pedido-observaciones');
const btnFinalizarPedido = document.getElementById('btn-finalizar-pedido');
const btnVaciarCarrito = document.getElementById('btn-vaciar-carrito'); 

const inputPedidoFechaEntrega = document.getElementById('pedido-fecha-entrega'); 
const selectPedidoMedioPago = document.getElementById('pedido-medio-pago'); 
const selectPedidoTipoEntrega = document.getElementById('pedido-tipo-entrega'); 

const listaPedidosCompletaDiv = document.getElementById('lista-pedidos-completa'); 
const mainNav = document.getElementById('main-nav');
const allSections = document.querySelectorAll('.app-section');

const formProducto = document.getElementById('form-producto');
const listaCatalogoUl = document.getElementById('lista-catalogo');
const inputProductoNombreNuevo = document.getElementById('producto-nombre-nuevo'); 
const inputProductoPrecioNuevo = document.getElementById('producto-precio-nuevo'); 
const inputBuscarCliente = document.getElementById('buscar-cliente');
const inputBuscarPedido = document.getElementById('buscar-pedido');
const filtroEstadoContenedor = document.getElementById('filtro-estado-contenedor'); 
const btnEditarCliente = document.getElementById('btn-editar-cliente');
const btnEliminarCliente = document.getElementById('btn-eliminar-cliente');
const btnImportarContacto = document.getElementById('btn-importar-contacto'); 

// Selectores de Edici√≥n de Cliente
const formEdicionClienteContainer = document.getElementById('form-edicion-cliente-container');
const formEdicionCliente = document.getElementById('form-edicion-cliente');
const btnCancelarEdicionCliente = document.getElementById('btn-cancelar-edicion-cliente');

// Selectores de Edici√≥n de Producto
const formNuevoProductoContainer = document.getElementById('form-nuevo-producto-container');
const formEdicionProductoContainer = document.getElementById('form-edicion-producto-container');
const btnCancelarEdicionProducto = document.getElementById('btn-cancelar-edicion-producto');

// Selectores del Modal de Edici√≥n de Pedido
const modalEdicionPedido = document.getElementById('modal-edicion-pedido');
const closeModalEdicionPedido = document.getElementById('close-modal-edicion-pedido');
const formEdicionPedidoModal = document.getElementById('form-edicion-pedido-modal');
const editPedidoIdHidden = document.getElementById('edit-pedido-id-hidden');
const editPedidoIdDisplay = document.getElementById('edit-pedido-id-display');
const itemsPedidoEdicionListaDiv = document.getElementById('items-pedido-edicion-lista');
const pedidoTotalEdicionResumenSpan = document.getElementById('pedido-total-edicion-resumen');
const editPedidoObservaciones = document.getElementById('edit-pedido-observaciones');
const editPedidoFechaEntrega = document.getElementById('edit-pedido-fecha-entrega'); 
const selectEditPedidoMedioPago = document.getElementById('edit-pedido-medio-pago'); 
const selectEditPedidoTipoEntrega = document.getElementById('edit-pedido-tipo-entrega'); 

// Selectores de Reportes
const reportesNav = document.getElementById('reportes-nav');
const reporteDiarioUl = document.getElementById('reporte-diario');
const reporteMensualUl = document.getElementById('reporte-mensual');
const reporteProductosUl = document.getElementById('reporte-productos');
const reportePagosUl = document.getElementById('reporte-pagos'); 
const reporteContents = document.querySelectorAll('.reporte-content');
const btnExportarReporte = document.getElementById('btn-exportar-reporte'); 

// Selectores de Configuraci√≥n
const formConfiguracion = document.getElementById('form-configuracion');
const configNombre = document.getElementById('config-nombre');
const configLogoUrl = document.getElementById('config-logo-url');
const configTelefono = document.getElementById('config-telefono');
const configRedes = document.getElementById('config-redes');
const configCbuAlias = document.getElementById('config-cbu-alias');
const configTitular = document.getElementById('config-titular');
const configPreviewDiv = document.getElementById('config-preview'); 
const appTitle = document.getElementById('app-title');
const headerBranding = document.getElementById('header-branding'); 
const headerAppName = document.getElementById('header-app-name'); 
const btnCompartirDatosBancarios = document.getElementById('btn-compartir-datos-bancarios'); 

// Notificaciones (Toast)
const appNotification = document.getElementById('app-notification');

// Selector para la fecha actual
const fechaActualDisplay = document.getElementById('fecha-actual-display');


let filtroEstadoActual = ''; 
let pedidoEditando = null; 

// ==========================================================
// 3. FUNCIONES DE UTILIDAD Y UX
// ==========================================================
/**
 * Muestra una notificaci√≥n temporal (Toast).
 */
const showNotification = (message, type = 'success') => {
    if (!appNotification) return; 

    appNotification.textContent = message;
    appNotification.className = 'show'; 
    appNotification.classList.add(`notification-${type}`);

    setTimeout(() => {
        appNotification.classList.remove('show');
        appNotification.classList.remove(`notification-${type}`);
    }, 3000);
};

/**
 * Controla la navegaci√≥n entre pesta√±as.
 */
const navigateTo = (targetId) => {
    allSections.forEach(section => {
        section.classList.remove('active-section');
    });

    const targetSection = document.getElementById(targetId);
    if (targetSection) {
        targetSection.classList.add('active-section');
        // Ejecutar funciones espec√≠ficas al cambiar de pesta√±a
        if (targetId === 'reportes-section') {
            generarReportes();
            const firstReportBtn = document.querySelector('.reportes-nav-btn');
            if (firstReportBtn && !document.querySelector('.reporte-content.active')) {
                firstReportBtn.click();
            }
        } else if (targetId === 'configuracion-section') {
            renderizarConfiguracion(); 
        } else if (targetId === 'lista-pedidos-section') {
            actualizarListaPedidos();
        }
    }

    document.querySelectorAll('.nav-button').forEach(button => {
        button.classList.remove('active');
        if (button.dataset.target === targetId) {
            button.classList.add('active');
        }
    });
};

/**
 * Listener para la navegaci√≥n principal.
 */
mainNav.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.target) {
        const targetId = e.target.dataset.target;
        navigateTo(targetId);
    }
});

/**
 * Listener para cambiar de reporte (pesta√±as internas).
 */
reportesNav.addEventListener('click', (e) => {
    if (e.target.classList.contains('reportes-nav-btn')) {
        const reporteSeleccionado = e.target.dataset.reporte;
        
        document.querySelectorAll('.reportes-nav-btn').forEach(btn => btn.classList.remove('active'));
        reporteContents.forEach(content => content.classList.remove('active'));
        
        e.target.classList.add('active');
        const targetContent = document.getElementById(`reporte-${reporteSeleccionado}-content`);
        if (targetContent) {
            targetContent.classList.add('active');
        }
    }
});

/**
 * Obtiene la fecha actual y la muestra en la interfaz.
 */
const mostrarFechaActual = () => {
    if (!fechaActualDisplay) return;

    const today = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = today.toLocaleDateString('es-ES', opciones);
    
    const [primeraLetra, ...resto] = fechaFormateada;
    fechaActualDisplay.textContent = primeraLetra.toUpperCase() + resto.join('');
};


// ==========================================================
// 4. GESTI√ìN DE CLIENTES
// ==========================================================

const toggleFormCliente = (editing = false) => {
    const formNuevoContainer = formCliente.parentElement.parentElement.querySelector('#form-nuevo-cliente-container');
    formEdicionClienteContainer.classList.toggle('hidden', !editing);
    if (formNuevoContainer) { 
        formNuevoContainer.classList.toggle('hidden', editing);
    }
    btnImportarContacto.classList.toggle('hidden', editing); 
};


const renderizarSelectClientes = (filtroTexto = '') => {
    selectClientesList.innerHTML = '';
    const filtro = filtroTexto.toLowerCase().trim();
    
    const clientesFiltrados = clientes.filter(cliente => 
        cliente.nombre.toLowerCase().includes(filtro) || 
        (cliente.telefono || '').includes(filtro) || 
        (cliente.direccion || '').toLowerCase().includes(filtro)
    ).sort((a, b) => a.nombre.localeCompare(b.nombre));

    if (clientes.length === 0) {
        selectClientesList.innerHTML = '<option value="">No hay clientes registrados</option>';
    }
    
    if (clientesFiltrados.length === 0 && filtro !== '') {
        selectClientesList.innerHTML = '<option value="">No se encontraron clientes</option>';
    }

    clientesFiltrados.forEach(cliente => {
        const telefonoDisplay = cliente.telefono ? ` | Tel: ${cliente.telefono}` : '';
        const direccionDisplay = cliente.direccion ? ` | Dir: ${cliente.direccion}` : '';
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = `${cliente.nombre}${telefonoDisplay}${direccionDisplay}`; 
        
        selectClientesList.appendChild(option);
    });
    
    if (filtroTexto === '') {
        selectPedidoCliente.innerHTML = '<option value="">-- Selecciona un Cliente para Empezar --</option>'; 
        clientes.forEach(cliente => {
            const telefonoPedido = cliente.telefono ? ` (Tel: ${cliente.telefono})` : '';
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = `${cliente.nombre}${telefonoPedido}`;
            selectPedidoCliente.appendChild(option);
        });
    }
    
    btnEditarCliente.disabled = !selectClientesList.value;
    btnEliminarCliente.disabled = !selectClientesList.value;
};

formCliente.addEventListener('submit', (e) => {
    e.preventDefault();
    const nombre = document.getElementById('cliente-nombre').value.trim();
    const telefono = document.getElementById('cliente-telefono').value.trim(); 
    const direccion = document.getElementById('cliente-direccion').value.trim(); 

    if (!nombre) { 
        showNotification('El nombre del cliente es obligatorio.', 'error');
        return;
    }

    const nuevoCliente = {
        id: Date.now(),
        nombre,
        telefono,
        direccion
    };

    clientes.push(nuevoCliente);
    guardarDatos('clientes', clientes);
    renderizarSelectClientes();
    formCliente.reset();
    showNotification('‚úÖ Cliente registrado con √©xito.');
});

if (btnImportarContacto) {
    btnImportarContacto.addEventListener('click', async () => {
        if (!('contacts' in navigator && 'select' in navigator.contacts)) {
            showNotification('‚ùå API de Contactos no soportada o requiere HTTPS.', 'error');
            return;
        }

        try {
            const props = ['name', 'tel', 'address'];
            const opts = { multiple: false };
            const contactos = await navigator.contacts.select(props, opts);

            if (contactos.length === 0) {
                showNotification('Importaci√≥n cancelada por el usuario.', 'info');
                return;
            }

            const contacto = contactos[0];
            const nombreCompleto = contacto.name && contacto.name.length > 0 ? contacto.name.join(' ') : 'Sin Nombre';
            const telefono = contacto.tel && contacto.tel.length > 0 ? contacto.tel[0] : '';
            let direccion = '';
            if (contacto.address && contacto.address.length > 0) {
                const addr = contacto.address[0];
                direccion = [addr.addressLine, addr.streetAddress, addr.locality, addr.region]
                            .filter(part => part) 
                            .join(', ');
            }

            const nuevoCliente = {
                id: Date.now(),
                nombre: nombreCompleto,
                telefono: telefono,
                direccion: direccion.trim()
            };

            clientes.push(nuevoCliente);
            guardarDatos('clientes', clientes);
            renderizarSelectClientes();
            
            showNotification(`‚úÖ Cliente "${nombreCompleto}" importado desde la agenda.`, 'success');

            document.getElementById('cliente-nombre').value = nuevoCliente.nombre;
            document.getElementById('cliente-telefono').value = nuevoCliente.telefono;
            document.getElementById('cliente-direccion').value = nuevoCliente.direccion;

        } catch (ex) {
            console.error('Error al acceder a la agenda:', ex);
            showNotification('‚ö†Ô∏è Error al intentar acceder a la agenda.', 'error');
        }
    });
}

selectClientesList.addEventListener('change', () => {
    btnEditarCliente.disabled = !selectClientesList.value;
    btnEliminarCliente.disabled = !selectClientesList.value;
});

btnEditarCliente.addEventListener('click', () => {
    const clienteId = selectClientesList.value;
    const cliente = clientes.find(c => c.id == clienteId);
    
    if (cliente) {
        document.getElementById('edit-cliente-id').value = cliente.id;
        document.getElementById('edit-cliente-nombre').value = cliente.nombre;
        document.getElementById('edit-cliente-telefono').value = cliente.telefono;
        document.getElementById('edit-cliente-direccion').value = cliente.direccion;
        toggleFormCliente(true);
    }
});

btnCancelarEdicionCliente.addEventListener('click', () => {
    toggleFormCliente(false);
    selectClientesList.value = ''; 
    renderizarSelectClientes();
});

document.getElementById('form-edicion-cliente').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-cliente-id').value;
    const index = clientes.findIndex(c => c.id == id);

    if (index !== -1) {
        clientes[index].nombre = document.getElementById('edit-cliente-nombre').value.trim();
        clientes[index].telefono = document.getElementById('edit-cliente-telefono').value.trim();
        clientes[index].direccion = document.getElementById('edit-cliente-direccion').value.trim();

        guardarDatos('clientes', clientes);
        renderizarSelectClientes();
        toggleFormCliente(false);
        showNotification('‚úèÔ∏è Cliente actualizado con √©xito.');
    }
});

btnEliminarCliente.addEventListener('click', () => {
    const clienteId = selectClientesList.value;
    const cliente = clientes.find(c => c.id == clienteId);
    
    if (cliente && confirm(`¬øEst√°s seguro de que quieres eliminar al cliente: ${cliente.nombre}? (Esto no elimina pedidos hist√≥ricos)`)) {
        clientes = clientes.filter(c => c.id != clienteId);
        guardarDatos('clientes', clientes);
        renderizarSelectClientes();
        showNotification('‚ùå Cliente eliminado.', 'error');
    }
});

inputBuscarCliente.addEventListener('input', (e) => {
    renderizarSelectClientes(e.target.value);
});


// ==========================================================
// 4.5. GESTI√ìN DEL CAT√ÅLOGO DE PRODUCTOS
// ==========================================================

const toggleFormProducto = (editing = false) => {
    formEdicionProductoContainer.classList.toggle('hidden', !editing);
    formNuevoProductoContainer.classList.toggle('hidden', editing);
};

const eliminarProductoCatalogo = (productoId) => {
    const largoInicial = catalogo.length;
    catalogo = catalogo.filter(p => p.id !== productoId);
    
    if (catalogo.length < largoInicial) {
        guardarDatos('catalogo', catalogo);
        renderizarCatalogo();
        showNotification('üóëÔ∏è Producto eliminado del cat√°logo.', 'error');
    } else {
        showNotification('Error: No se encontr√≥ el producto en el cat√°logo.', 'error');
    }
};

const renderizarCatalogo = () => {
    listaCatalogoUl.innerHTML = '';
    selectPedidoProducto.innerHTML = '<option value="">Selecciona un Producto</option>';

    if (catalogo.length === 0) {
        listaCatalogoUl.innerHTML = '<li>No hay productos en el cat√°logo.</li>';
        return;
    }

    catalogo.forEach(producto => {
        const li = document.createElement('li');
        li.className = 'catalogo-item'; 
        
        li.innerHTML = `
            <span>${producto.nombre}</span>
            <strong>$${parseFloat(producto.precio).toFixed(2)}</strong>
        `;

        const btnEditar = document.createElement('button');
        btnEditar.textContent = '‚úçÔ∏è';
        btnEditar.title = `Editar ${producto.nombre}`;
        btnEditar.addEventListener('click', () => {
            cargarProductoParaEdicion(producto.id);
        });
        li.appendChild(btnEditar);
        
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = '‚úñÔ∏è';
        btnEliminar.className = 'btn-eliminar-producto';
        btnEliminar.title = `Eliminar ${producto.nombre} del cat√°logo`;
        btnEliminar.addEventListener('click', () => {
            if(confirm(`¬øEst√°s seguro de que quieres eliminar "${producto.nombre}" del cat√°logo?`)) {
                eliminarProductoCatalogo(producto.id); 
            }
        });
        
        li.appendChild(btnEliminar);
        listaCatalogoUl.appendChild(li);

        const option = document.createElement('option');
        option.value = producto.id; 
        option.textContent = `${producto.nombre} ($${parseFloat(producto.precio).toFixed(2)})`;
        option.dataset.precio = producto.precio; 
        selectPedidoProducto.appendChild(option);
    });
};

const cargarProductoParaEdicion = (productoId) => {
    const producto = catalogo.find(p => p.id == productoId);
    if (producto) {
        document.getElementById('edit-producto-id').value = producto.id;
        document.getElementById('edit-producto-nombre').value = producto.nombre;
        document.getElementById('edit-producto-precio').value = producto.precio;
        toggleFormProducto(true);
    }
};

btnCancelarEdicionProducto.addEventListener('click', () => {
    toggleFormProducto(false);
});

formProducto.addEventListener('submit', (e) => {
    e.preventDefault();
    const nombre = inputProductoNombreNuevo.value.trim();
    const precio = inputProductoPrecioNuevo.value; 

    if (!nombre || !precio) return;
    
    if (catalogo.some(p => p.nombre.toLowerCase() === nombre.toLowerCase())) {
        showNotification('Este producto ya existe en el cat√°logo.', 'error');
        return;
    }

    const nuevoProducto = {
        id: Date.now(),
        nombre,
        precio: parseFloat(precio), 
    };

    catalogo.push(nuevoProducto);
    guardarDatos('catalogo', catalogo);
    renderizarCatalogo();
    formProducto.reset();
    showNotification(`üì¶ Producto "${nombre}" agregado.`, 'success');
});

document.getElementById('form-edicion-producto').addEventListener('submit', (e) => {
    e.preventDefault();
    const id = document.getElementById('edit-producto-id').value;
    const index = catalogo.findIndex(p => p.id == id);
    const nombre = document.getElementById('edit-producto-nombre').value.trim();
    const precio = parseFloat(document.getElementById('edit-producto-precio').value);

    if (index !== -1) {
        catalogo[index].nombre = nombre;
        catalogo[index].precio = precio;

        guardarDatos('catalogo', catalogo);
        renderizarCatalogo();
        toggleFormProducto(false);
        showNotification('‚úèÔ∏è Producto actualizado con √©xito.');
    }
});


// ==========================================================
// 5. GESTI√ìN DE PEDIDOS (Creaci√≥n, Edici√≥n y Guardado)
// ==========================================================

const actualizarEstadoFormularioPedido = () => {
    const clienteSeleccionado = selectPedidoCliente.value !== '';
    const medioPagoSeleccionado = selectPedidoMedioPago.value !== '';
    const tipoEntregaSeleccionado = selectPedidoTipoEntrega.value !== '';
    const tieneItems = carrito.length > 0;

    // Condici√≥n para habilitar el bot√≥n de finalizar
    const puedeFinalizar = clienteSeleccionado && tieneItems && medioPagoSeleccionado && tipoEntregaSeleccionado;
    
    // Habilitar/Deshabilitar inputs de productos si hay cliente seleccionado
    selectPedidoProducto.disabled = !clienteSeleccionado;
    inputPedidoCantidad.disabled = !clienteSeleccionado;
    btnAgregarItem.disabled = !clienteSeleccionado;
    
    // Habilitar/Deshabilitar otros campos si hay cliente seleccionado
    inputPedidoObservaciones.disabled = !clienteSeleccionado;
    inputPedidoFechaEntrega.disabled = !clienteSeleccionado;
    selectPedidoMedioPago.disabled = !clienteSeleccionado; 
    selectPedidoTipoEntrega.disabled = !clienteSeleccionado; 
    
    // Habilitar/Deshabilitar bot√≥n de finalizar
    btnFinalizarPedido.disabled = !puedeFinalizar;
    
    // Manejo de Carrito (Antirrecurrente)
    if (selectPedidoCliente.value === '') {
        if (carrito.length > 0) {
             carrito = [];
             renderizarCarrito(); // Renderiza el carrito vac√≠o
        }
    }
};

// Listeners de cambio para actualizar el estado
selectPedidoCliente.addEventListener('change', () => {
    // Cuando el cliente cambia, actualiza el estado. 
    actualizarEstadoFormularioPedido();
});

// ¬°IMPORTANTE! Asegurarse de que al cambiar estos campos se actualice el estado
selectPedidoMedioPago.addEventListener('change', actualizarEstadoFormularioPedido);
selectPedidoTipoEntrega.addEventListener('change', actualizarEstadoFormularioPedido);


selectPedidoProducto.addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    
    if (selectedOption.value) {
        const precio = selectedOption.dataset.precio;
        inputPedidoPrecioUnitario.value = parseFloat(precio).toFixed(2);
    } else {
        inputPedidoPrecioUnitario.value = '';
    }
    inputPedidoCantidad.value = 1; 
});


const renderizarCarrito = () => {
    itemsPedidoListaDiv.innerHTML = '';
    let total = 0;

    if (carrito.length === 0) {
        itemsPedidoListaDiv.innerHTML = '<p style="text-align: center; color: #aaa;">No hay productos en el pedido.</p>';
        pedidoTotalResumenSpan.textContent = '$0.00';
    }

    carrito.forEach((item, index) => {
        const itemTotal = item.cantidad * item.precioUnitario;
        total += itemTotal;
        
        const div = document.createElement('div');
        div.className = 'carrito-item';

        div.innerHTML = `
            <span class="carrito-item-info">
                ${item.cantidad}x <strong>${item.nombre}</strong> 
                ($${item.precioUnitario.toFixed(2)} c/u)
            </span>
            <span>$${itemTotal.toFixed(2)}</span>
            <button data-index="${index}" title="Eliminar √≠tem">‚úñÔ∏è</button>
        `;

        div.querySelector('button').addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            carrito.splice(idx, 1);
            // Si eliminas un √≠tem, necesitas volver a renderizar y actualizar el estado
            renderizarCarrito(); 
        });

        itemsPedidoListaDiv.appendChild(div);
    });

    pedidoTotalResumenSpan.textContent = `$${total.toFixed(2)}`;
    
    // Llamar a actualizarEstadoFormularioPedido aqu√≠ es seguro (sin recursi√≥n) y necesario
    // para habilitar/deshabilitar el bot√≥n de finalizar despu√©s de agregar/eliminar √≠tems.
    actualizarEstadoFormularioPedido(); 
};


btnAgregarItem.addEventListener('click', () => {
    const productoId = selectPedidoProducto.value;
    const cantidad = parseInt(inputPedidoCantidad.value);
    
    if (!productoId || !cantidad || cantidad < 1) {
        showNotification('Por favor, selecciona un producto y especifica una cantidad v√°lida (m√≠nimo 1).', 'error');
        return;
    }
    
    const productoSeleccionado = catalogo.find(p => p.id == productoId);
    if (!productoSeleccionado) {
        showNotification('Error: Producto no encontrado en el cat√°logo.', 'error');
        return;
    }
    
    const precioUnitario = productoSeleccionado.precio; 
    
    carrito.push({
        id: productoId, 
        nombre: productoSeleccionado.nombre,
        cantidad: cantidad,
        precioUnitario: precioUnitario 
    });
    
    renderizarCarrito();
    
    selectPedidoProducto.value = '';
    inputPedidoCantidad.value = 1;
    inputPedidoPrecioUnitario.value = ''; 
});

// Listener del bot√≥n Vaciar Carrito
if (btnVaciarCarrito) {
    btnVaciarCarrito.addEventListener('click', () => {
        if (carrito.length > 0 && confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
            carrito = [];
            renderizarCarrito();
            showNotification('Carrito vaciado.', 'info');
        }
    });
}


formPedido.addEventListener('submit', (e) => {
    e.preventDefault();
    const clienteId = selectPedidoCliente.value;
    const observaciones = inputPedidoObservaciones.value.trim(); 
    const fechaEntrega = inputPedidoFechaEntrega.value || null; 
    const medioPago = selectPedidoMedioPago.value; 
    const tipoEntrega = selectPedidoTipoEntrega.value; 

    if (carrito.length === 0 || !clienteId || !medioPago || !tipoEntrega) {
        showNotification('Faltan productos o datos obligatorios del pedido.', 'error');
        return;
    }
    
    // ‚úÖ CORRECCI√ìN ID: Incremento del contador sucesivo
    contadorPedidos++;
    guardarContador(); 

    const precioTotal = carrito.reduce((sum, item) => sum + (item.cantidad * item.precioUnitario), 0);

    const nuevoPedido = {
        id: contadorPedidos, // Usa el contador sucesivo (ej: 1, 2, 3...)
        productos: carrito, 
        precio: parseFloat(precioTotal.toFixed(2)), 
        clienteId: clienteId, 
        observaciones: observaciones,
        estado: "Pendiente", 
        fechaCreacion: new Date().toISOString(), 
        fechaEntrega: fechaEntrega, 
        medioPago: medioPago, 
        tipoEntrega: tipoEntrega, 
    };

    pedidos.push(nuevoPedido);
    guardarDatos('pedidos', pedidos); 
    
    // LIMPIEZA
    carrito = []; 
    // Llama a renderizar y actualizar estado como √∫ltimo paso de limpieza
    renderizarCarrito(); 
    selectPedidoCliente.value = ''; 
    inputPedidoObservaciones.value = ''; 
    selectPedidoProducto.value = '';
    inputPedidoPrecioUnitario.value = '';
    inputPedidoCantidad.value = 1; 
    inputPedidoFechaEntrega.value = ''; 
    selectPedidoMedioPago.value = ''; 
    selectPedidoTipoEntrega.value = ''; 
    actualizarEstadoFormularioPedido(); 

    // RENDERIZADO Y NAVEGACI√ìN
    actualizarListaPedidos(); 
    navigateTo('lista-pedidos-section'); 
    showNotification(`üéâ Pedido #${nuevoPedido.id} creado y guardado con √©xito.`, 'success');
});


// L√≥gica de Edici√≥n de Pedidos (Modal)

const renderizarCarritoEdicion = () => {
    itemsPedidoEdicionListaDiv.innerHTML = '';
    let total = 0;

    if (carritoEdicion.length === 0) {
        itemsPedidoEdicionListaDiv.innerHTML = '<p style="text-align: center; color: #aaa;">No hay productos.</p>';
        pedidoTotalEdicionResumenSpan.textContent = '$0.00';
        return;
    }

    carritoEdicion.forEach((item, index) => {
        const itemTotal = item.cantidad * item.precioUnitario;
        total += itemTotal;
        
        const div = document.createElement('div');
        div.className = 'carrito-item';

        div.innerHTML = `
            <span class="carrito-item-info">
                <strong>${item.nombre}</strong> ($${item.precioUnitario.toFixed(2)} c/u)
            </span>
            <input type="number" data-index="${index}" min="1" value="${item.cantidad}">
            <span>$${itemTotal.toFixed(2)}</span>
            <button data-index="${index}" title="Eliminar √≠tem">‚úñÔ∏è</button>
        `;

        div.querySelector('input[type="number"]').addEventListener('change', (e) => {
            const idx = parseInt(e.target.dataset.index);
            const newCantidad = parseInt(e.target.value);
            if (newCantidad > 0) {
                carritoEdicion[idx].cantidad = newCantidad;
            } else {
                carritoEdicion.splice(idx, 1); 
            }
            renderizarCarritoEdicion();
        });

        div.querySelector('button').addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            carritoEdicion.splice(idx, 1);
            renderizarCarritoEdicion(); 
        });

        itemsPedidoEdicionListaDiv.appendChild(div);
    });

    pedidoTotalEdicionResumenSpan.textContent = `$${total.toFixed(2)}`;
};

const abrirModalEdicionPedido = (pedidoId) => {
    pedidoEditando = pedidos.find(p => p.id == pedidoId);
    
    if (pedidoEditando) {
        // Clonaci√≥n profunda del array de productos para edici√≥n
        carritoEdicion = JSON.parse(JSON.stringify(pedidoEditando.productos)); 

        editPedidoIdHidden.value = pedidoEditando.id;
        editPedidoIdDisplay.textContent = `#${pedidoEditando.id}`;
        editPedidoObservaciones.value = pedidoEditando.observaciones || '';
        editPedidoFechaEntrega.value = pedidoEditando.fechaEntrega || ''; 
        
        selectEditPedidoMedioPago.value = pedidoEditando.medioPago || 'Efectivo'; 
        selectEditPedidoTipoEntrega.value = pedidoEditando.tipoEntrega || 'Retira'; 
        
        renderizarCarritoEdicion();
        modalEdicionPedido.classList.remove('hidden');
        modalEdicionPedido.style.display = 'block'; // Mostrar modal
    }
};

closeModalEdicionPedido.addEventListener('click', () => {
    modalEdicionPedido.style.display = 'none';
    pedidoEditando = null;
    carritoEdicion = []; 
});

// Cerrar modal al hacer clic fuera de √©l
window.addEventListener('click', (event) => {
    if (event.target === modalEdicionPedido) {
        modalEdicionPedido.style.display = 'none';
        pedidoEditando = null;
        carritoEdicion = []; 
    }
});


formEdicionPedidoModal.addEventListener('submit', (e) => {
    e.preventDefault();

    if (!pedidoEditando) return;

    const nuevaFechaEntrega = editPedidoFechaEntrega.value || null; 
    const nuevoMedioPago = selectEditPedidoMedioPago.value; 
    const nuevoTipoEntrega = selectEditPedidoTipoEntrega.value; 

    if (carritoEdicion.length === 0) {
        showNotification('El pedido editado no puede quedar sin productos.', 'error');
        return;
    }
    
    if (!nuevoMedioPago || !nuevoTipoEntrega) { 
        showNotification('El medio y tipo de pago/entrega son obligatorios.', 'error');
        return;
    }

    const precioTotal = carritoEdicion.reduce((sum, item) => sum + (item.cantidad * item.precioUnitario), 0);
    const index = pedidos.findIndex(p => p.id == pedidoEditando.id);
    
    if (index !== -1) {
        pedidos[index].productos = carritoEdicion;
        pedidos[index].precio = parseFloat(precioTotal.toFixed(2));
        pedidos[index].observaciones = editPedidoObservaciones.value.trim();
        pedidos[index].fechaEntrega = nuevaFechaEntrega;
        pedidos[index].medioPago = nuevoMedioPago; 
        pedidos[index].tipoEntrega = nuevoTipoEntrega; 
        
        const ventaIndex = ventasHistorial.findIndex(v => v.pedidoId === pedidos[index].id);
        if (ventaIndex !== -1) {
            // Actualiza la venta hist√≥rica si ya estaba registrada
            ventasHistorial[ventaIndex].productos = carritoEdicion;
            ventasHistorial[ventaIndex].monto = pedidos[index].precio;
            ventasHistorial[ventaIndex].medioPago = pedidos[index].medioPago;
            guardarDatos('ventasHistorial', ventasHistorial);
            generarReportes();
        }

        guardarDatos('pedidos', pedidos);
        actualizarListaPedidos(inputBuscarPedido.value);
        showNotification(`‚úÖ Pedido #${pedidos[index].id} actualizado.`, 'success');
        modalEdicionPedido.style.display = 'none';
    }
});


// FUNCI√ìN DE VISUALIZACI√ìN DE PEDIDOS 
const obtenerNombreCliente = (clienteId) => {
    const cliente = clientes.find(c => c.id == clienteId);
    
    if (!cliente) {
        return 'Cliente Eliminado/Desconocido';
    }

    const telefonoTexto = cliente.telefono ? `Tel: ${cliente.telefono}` : '';
    const direccionTexto = cliente.direccion ? `Dir: ${cliente.direccion}` : '';
    
    let infoExtra = [];
    if (telefonoTexto) infoExtra.push(telefonoTexto);
    if (direccionTexto) infoExtra.push(direccionTexto);

    return `${cliente.nombre}${infoExtra.length > 0 ? ` (${infoExtra.join(' | ')})` : ''}`;
};

const crearTarjetaPedido = (pedido) => {
    const card = document.createElement('div');
    card.className = `pedido-card estado-${pedido.estado.replace(' ', '_')}`;

    const clienteInfo = obtenerNombreCliente(pedido.clienteId); 
    const productosDelPedido = pedido.productos || [];
    
    let fechaCreacionDisplay = 'Fecha Desconocida';
    if (pedido.fechaCreacion) {
        const fechaC = new Date(pedido.fechaCreacion);
        if (!isNaN(fechaC)) {
            fechaCreacionDisplay = fechaC.toLocaleDateString('es-ES', { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        }
    }
    
    let fechaEntregaDisplay = 'No especificada';
    if (pedido.fechaEntrega) {
        // Se asume que la fecha de entrega est√° en formato YYYY-MM-DD
        fechaEntregaDisplay = new Date(pedido.fechaEntrega + 'T00:00:00').toLocaleDateString('es-ES', { 
            year: 'numeric', month: 'long', day: 'numeric' 
        });
    }
    
    const listaProductos = productosDelPedido.map(item => 
        `<li>${item.cantidad}x ${item.nombre} ($${(item.cantidad * item.precioUnitario).toFixed(2)})</li>`
    ).join('');
    
    const tipoEntregaDisplay = pedido.tipoEntrega || 'N/A';
    const medioPagoDisplay = pedido.medioPago || 'N/A';

    card.innerHTML = `
        <h3>Pedido #${pedido.id}</h3>
        <p><strong>Cliente:</strong> ${clienteInfo}</p>
        <p><strong>Total:</strong> $${pedido.precio.toFixed(2)}</p>
        <p><strong>Creado:</strong> ${fechaCreacionDisplay}</p>
        <p><strong>Entrega:</strong> ${fechaEntregaDisplay}</p>
        <p><strong>Tipo:</strong> ${tipoEntregaDisplay} | <strong>Pago:</strong> ${medioPagoDisplay}</p>
        <p><strong>Items:</strong></p>
        <ul style="margin-left: 20px; font-size: 0.9em;">${listaProductos}</ul>
        ${pedido.observaciones ? `<p style="font-style: italic;">Obs: ${pedido.observaciones}</p>` : ''}
        <hr style="border: 0; border-top: 1px dashed #eee;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
            <div style="flex-basis: 100%; margin-bottom: 10px; display: flex; align-items: center;">
                <label for="estado-select-${pedido.id}">Estado:</label>
                <select id="estado-select-${pedido.id}" data-pedido-id="${pedido.id}" style="flex-grow: 1;">
                    <option value="Pendiente">Pendiente</option>
                    <option value="En Proceso">En Proceso</option>
                    <option value="Entregado">Entregado</option>
                </select>
            </div>
            <div class="action-buttons-pedido">
                <button class="btn-editar-pedido secondary-btn" data-pedido-id="${pedido.id}">‚úçÔ∏è Editar</button>
                <button class="btn-primary btn-eliminar-pedido" data-pedido-id="${pedido.id}">‚ùå Eliminar</button>
            </div>
        </div>
    `;
    
    card.querySelector(`#estado-select-${pedido.id}`).value = pedido.estado;

    card.querySelector(`#estado-select-${pedido.id}`).addEventListener('change', (e) => {
        const nuevoEstado = e.target.value;
        actualizarEstadoPedido(pedido.id, nuevoEstado);
    });
    
    card.querySelector('.btn-editar-pedido').addEventListener('click', () => {
        abrirModalEdicionPedido(pedido.id);
    });
    
    card.querySelector('.btn-eliminar-pedido').addEventListener('click', () => {
        if(confirm(`¬øEst√°s seguro de que quieres eliminar el Pedido #${pedido.id}?`)) {
            eliminarPedido(pedido.id);
        }
    });

    return card;
};

/**
 * Funci√≥n que actualiza la lista de pedidos en la vista, aplicando filtros y b√∫squeda.
 */
const actualizarListaPedidos = (busqueda = inputBuscarPedido.value || '', estado = filtroEstadoActual) => {
    listaPedidosCompletaDiv.innerHTML = '';
    const busquedaLower = busqueda.toLowerCase().trim();

    const pedidosFiltrados = pedidos.filter(pedido => {
        if (estado && estado !== '' && pedido.estado !== estado) {
            return false;
        }

        if (busquedaLower === '') return true;

        const cliente = clientes.find(c => c.id == pedido.clienteId);
        const nombreCliente = cliente ? cliente.nombre.toLowerCase() : '';
        const idStr = pedido.id.toString(); 
        const productosStr = pedido.productos.map(p => p.nombre.toLowerCase()).join(' ');

        return (
            idStr.includes(busquedaLower) ||
            nombreCliente.includes(busquedaLower) ||
            productosStr.includes(busquedaLower) ||
            (pedido.fechaEntrega || '').includes(busquedaLower)
        );
    }).sort((a, b) => b.id - a.id); 

    if (pedidosFiltrados.length === 0) {
        listaPedidosCompletaDiv.innerHTML = `<p style="text-align: center; color: #ff66b2;">No se encontraron pedidos con los filtros aplicados.</p>`;
        return;
    }

    pedidosFiltrados.forEach(pedido => {
        listaPedidosCompletaDiv.appendChild(crearTarjetaPedido(pedido));
    });
};

/**
 * Actualiza el estado de un pedido y registra la venta si se marca como 'Entregado'.
 */
const actualizarEstadoPedido = (pedidoId, nuevoEstado) => {
    const index = pedidos.findIndex(p => p.id == pedidoId);
    
    if (index !== -1) {
        const pedido = pedidos[index];
        const estadoAnterior = pedido.estado;
        
        pedido.estado = nuevoEstado;
        
        const ventaIndex = ventasHistorial.findIndex(v => v.pedidoId === pedidoId);

        if (nuevoEstado === 'Entregado' && estadoAnterior !== 'Entregado') {
            // REGISTRAR VENTA
            const nuevaVenta = {
                pedidoId: pedido.id,
                fechaEntrega: new Date().toISOString().split('T')[0], 
                monto: pedido.precio,
                clienteId: pedido.clienteId,
                productos: pedido.productos,
                medioPago: pedido.medioPago,
                tipoEntrega: pedido.tipoEntrega,
            };
            ventasHistorial.push(nuevaVenta);
            showNotification(`üí∞ Pedido #${pedido.id} marcado como Entregado. Venta Registrada.`, 'success');
        } else if (nuevoEstado !== 'Entregado' && estadoAnterior === 'Entregado') {
            // ELIMINAR VENTA (si se revierte de Entregado)
            if (ventaIndex !== -1) {
                ventasHistorial.splice(ventaIndex, 1);
                showNotification(`‚ö†Ô∏è Pedido #${pedido.id} revertido. Venta Descontada.`, 'error');
            }
        } 
        
        // Guardar y actualizar vista
        guardarDatos('pedidos', pedidos);
        guardarDatos('ventasHistorial', ventasHistorial);
        
        actualizarListaPedidos(inputBuscarPedido.value);
        generarReportes(); 
    }
};

/**
 * Elimina un pedido y su registro de venta (si existe).
 */
const eliminarPedido = (pedidoId) => {
    const largoInicial = pedidos.length;
    
    pedidos = pedidos.filter(p => p.id !== pedidoId);
    
    if (pedidos.length < largoInicial) {
        const ventaIndex = ventasHistorial.findIndex(v => v.pedidoId === pedidoId);
        if (ventaIndex !== -1) {
            ventasHistorial.splice(ventaIndex, 1);
            guardarDatos('ventasHistorial', ventasHistorial);
        }
        
        guardarDatos('pedidos', pedidos);
        actualizarListaPedidos(inputBuscarPedido.value);
        generarReportes();
        showNotification(`‚ùå Pedido #${pedidoId} eliminado.`, 'error');
    }
};

// --- LISTENERS DE FILTRO Y B√öSQUEDA ---
inputBuscarPedido.addEventListener('input', () => {
    actualizarListaPedidos(inputBuscarPedido.value);
});

filtroEstadoContenedor.addEventListener('click', (e) => {
    if (e.target.classList.contains('filtro-estado-btn')) {
        document.querySelectorAll('.filtro-estado-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        filtroEstadoActual = e.target.dataset.estado;
        actualizarListaPedidos(inputBuscarPedido.value, filtroEstadoActual);
    }
});


// ==========================================================
// 6. REPORTES Y EXPORTACI√ìN
// ==========================================================

const generarReportes = () => {
    if (ventasHistorial.length === 0) {
        const mensaje = '<li>No hay ventas entregadas para reportar.</li>';
        reporteDiarioUl.innerHTML = mensaje;
        reporteMensualUl.innerHTML = mensaje;
        reporteProductosUl.innerHTML = mensaje;
        reportePagosUl.innerHTML = mensaje;
        return;
    }
    
    const reportes = {
        diario: generarReporteDiario(),
        mensual: generarReporteMensual(),
        productos: generarReporteProductos(),
        pagos: generarReportePagos(),
    };
    
    renderizarReporte(reporteDiarioUl, reportes.diario);
    renderizarReporte(reporteMensualUl, reportes.mensual);
    renderizarReporteProductos(reporteProductosUl, reportes.productos);
    renderizarReporte(reportePagosUl, reportes.pagos);
};

const generarReporteDiario = () => {
    const reporte = {}; 
    ventasHistorial.forEach(venta => {
        const fechaISO = venta.fechaEntrega || '2000-01-01'; 
        reporte[fechaISO] = (reporte[fechaISO] || 0) + venta.monto;
    });
    
    return Object.keys(reporte).map(fechaISO => {
        const fecha = new Date(fechaISO + 'T00:00:00'); 
        return {
            etiqueta: fecha.toLocaleDateString('es-ES', { 
                day: 'numeric', month: 'long', year: 'numeric' 
            }),
            monto: reporte[fechaISO],
            orden: fechaISO 
        };
    }).sort((a, b) => b.orden.localeCompare(a.orden)); 
};

const generarReporteMensual = () => {
    const reporte = {}; 
    ventasHistorial.forEach(venta => {
        const fecha = venta.fechaEntrega || '2000-01-01'; 
        const mes = fecha.slice(0, 7); // YYYY-MM
        reporte[mes] = (reporte[mes] || 0) + venta.monto;
    });
    
    return Object.keys(reporte).map(mes => {
        const fechaInicialMes = new Date(mes + '-01' + 'T00:00:00'); 
        return {
            etiqueta: fechaInicialMes.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
            monto: reporte[mes],
            orden: mes
        };
    }).sort((a, b) => b.orden.localeCompare(a.orden));
};

const generarReporteProductos = () => {
    const reporte = {}; 
    ventasHistorial.forEach(venta => {
        venta.productos.forEach(item => {
            if (!reporte[item.nombre]) {
                reporte[item.nombre] = { cantidad: 0, monto: 0 };
            }
            reporte[item.nombre].cantidad += item.cantidad;
            reporte[item.nombre].monto += item.cantidad * item.precioUnitario;
        });
    });

    return Object.keys(reporte).map(nombre => ({
        nombre: nombre,
        cantidad: reporte[nombre].cantidad,
        monto: reporte[nombre].monto
    })).sort((a, b) => b.cantidad - a.cantidad); 
};

const generarReportePagos = () => {
    const reporte = {}; 
    ventasHistorial.forEach(venta => {
        const medio = venta.medioPago || 'Desconocido';
        reporte[medio] = (reporte[medio] || 0) + venta.monto;
    });
    
    return Object.keys(reporte).map(medio => ({
        etiqueta: medio,
        monto: reporte[medio],
        orden: reporte[medio] 
    })).sort((a, b) => b.orden - a.orden);
};


const renderizarReporte = (ulElement, datosReporte) => {
    ulElement.innerHTML = '';
    const totalGlobal = datosReporte.reduce((sum, item) => sum + item.monto, 0);

    ulElement.innerHTML = `<li style="font-weight: bold; color: var(--primary-color);">TOTAL GLOBAL: $${totalGlobal.toFixed(2)}</li><hr>`;
    
    datosReporte.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.etiqueta}: $${item.monto.toFixed(2)}`;
        ulElement.appendChild(li);
    });
};

const renderizarReporteProductos = (ulElement, datosReporte) => {
    ulElement.innerHTML = '';
    const totalUnidades = datosReporte.reduce((sum, item) => sum + item.cantidad, 0);
    const totalVendido = datosReporte.reduce((sum, item) => sum + item.monto, 0);

    ulElement.innerHTML = `
        <li style="font-weight: bold; color: var(--primary-color);">TOTAL UNIDADES VENDIDAS: ${totalUnidades}</li>
        <li style="font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">VENTA TOTAL EN PRODUCTOS: $${totalVendido.toFixed(2)}</li>
        <hr>
    `;

    datosReporte.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - ${item.cantidad} unidades | $${item.monto.toFixed(2)}`;
        ulElement.appendChild(li);
    });
};


btnExportarReporte.addEventListener('click', () => {
    const activeReporteElement = document.querySelector('.reporte-content.active');
    if (!activeReporteElement) {
        showNotification('No se encontr√≥ el reporte activo para exportar.', 'error');
        return;
    }

    const reporteType = activeReporteElement.id.replace('reporte-', '').replace('-content', '');
    let headers = [];
    let data = [];
    let fileName = '';

    switch (reporteType) {
        case 'diario':
            const repDiario = generarReporteDiario();
            headers = ['Fecha', 'Monto'];
            data = repDiario.map(item => [item.etiqueta, item.monto.toFixed(2)]);
            fileName = 'Reporte_Ventas_Diarias';
            break;
        case 'mensual':
            const repMensual = generarReporteMensual();
            headers = ['Mes', 'Monto'];
            data = repMensual.map(item => [item.etiqueta, item.monto.toFixed(2)]);
            fileName = 'Reporte_Ventas_Mensuales';
            break;
        case 'productos':
            const repProductos = generarReporteProductos();
            headers = ['Producto', 'Unidades Vendidas', 'Monto Total'];
            data = repProductos.map(item => [item.nombre, item.cantidad, item.monto.toFixed(2)]);
            fileName = 'Reporte_Productos_Vendidos';
            break;
        case 'pagos':
            const repPagos = generarReportePagos(); 
            headers = ['Medio de Pago', 'Monto Total'];
            data = repPagos.map(item => [item.etiqueta, item.monto.toFixed(2)]);
            fileName = 'Reporte_Total_Pagos';
            break;
        default:
            showNotification('Tipo de reporte desconocido.', 'error');
            return;
    }

    if (data.length === 0) {
        showNotification('El reporte no contiene datos para exportar.', 'error');
        return;
    }

    const csvContent = [
        headers.join(';'),
        ...data.map(row => row.join(';'))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `${fileName}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`‚¨áÔ∏è Reporte "${fileName}" exportado a CSV.`, 'success');
});


// ==========================================================
// 7. CONFIGURACI√ìN
// ==========================================================

const renderizarConfiguracion = () => {
    configNombre.value = configuracion.nombre || '';
    configLogoUrl.value = configuracion.logoUrl || '';
    configTelefono.value = configuracion.telefono || '';
    configRedes.value = configuracion.redes || '';
    configCbuAlias.value = configuracion.cbuAlias || '';
    configTitular.value = configuracion.titular || '';

    // Actualizar la vista previa
    configPreviewDiv.innerHTML = `
        <h3>Vista Previa</h3>
        <p><strong>Nombre:</strong> ${configuracion.nombre || 'N/A'}</p>
        <p><strong>Tel√©fono:</strong> ${configuracion.telefono || 'N/A'}</p>
        <p><strong>Redes:</strong> ${configuracion.redes || 'N/A'}</p>
        <h4>Datos Bancarios</h4>
        <p><strong>CBU/Alias:</strong> ${configuracion.cbuAlias || 'N/A'}</p>
        <p><strong>Titular:</strong> ${configuracion.titular || 'N/A'}</p>
    `;
};

const aplicarConfiguracionAHeader = () => {
    if (!headerAppName || !appTitle || !headerBranding) return;

    headerAppName.textContent = configuracion.nombre || 'Gesti√≥n de Pedidos';
    appTitle.textContent = `${configuracion.nombre || 'Gesti√≥n de Pedidos'} | App`;

    let logoImg = document.querySelector('#header-branding img');
    if (configuracion.logoUrl) {
        if (!logoImg) {
            logoImg = document.createElement('img');
            headerBranding.insertBefore(logoImg, headerAppName);
        }
        logoImg.src = configuracion.logoUrl;
        logoImg.alt = 'Logo';
    } else if (logoImg) {
        logoImg.remove();
    }
};

formConfiguracion.addEventListener('submit', (e) => {
    e.preventDefault();
    
    configuracion.nombre = configNombre.value.trim();
    configuracion.logoUrl = configLogoUrl.value.trim();
    configuracion.telefono = configTelefono.value.trim();
    configuracion.redes = configRedes.value.trim();
    configuracion.cbuAlias = configCbuAlias.value.trim();
    configuracion.titular = configTitular.value.trim();
    
    guardarDatos('configuracion', configuracion);
    aplicarConfiguracionAHeader();
    renderizarConfiguracion();
    showNotification('Configuraci√≥n guardada exitosamente. üíæ');
});

btnCompartirDatosBancarios.addEventListener('click', () => {
    const { nombre, telefono, cbuAlias, titular } = configuracion;
    
    if (!cbuAlias || !titular) {
        showNotification('‚ùå Por favor, completa los datos bancarios en el formulario primero.', 'error');
        return;
    }

    let mensaje = `¬°Hola! üëã Aqu√≠ te dejo los datos para realizar la transferencia de tu pedido con ${nombre || 'Nosotros'}:\n\n`;
    mensaje += `*CBU/ALIAS:* ${cbuAlias}\n`;
    mensaje += `*Titular:* ${titular}\n\n`;
    if (telefono) {
        mensaje += `Cualquier duda, puedes escribirme al ${telefono}.\n`;
    }
    mensaje += `¬°Gracias por tu compra! ‚ù§Ô∏è`;
    
    const phone = configuracion.telefono ? configuracion.telefono.replace(/\s/g, '').replace('+', '') : ''; 
    const encodedMessage = encodeURIComponent(mensaje);
    const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
});


// ==========================================================
// 8. EJECUCI√ìN DEL PROGRAMA
// ==========================================================
const init = () => {
    cargarDatosIniciales();
    aplicarConfiguracionAHeader(); 
    mostrarFechaActual(); 
    renderizarSelectClientes();
    renderizarCatalogo();
    // Es CRUCIAL que renderizarCarrito se llame s√≥lo UNA VEZ al inicio.
    renderizarCarrito(); 
    actualizarEstadoFormularioPedido();
    navigateTo('pedidos-section'); 
    actualizarListaPedidos();
    generarReportes(); 
};

window.addEventListener('load', init);
